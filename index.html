<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Объединение Excel файлов</title>
    <!-- Подключаем библиотеку SheetJS для работы с Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .drop-area {
            border: 2px dashed #3498db;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
            background-color: #f8f9fa;
            transition: background-color 0.3s;
        }
        .drop-area.highlight {
            background-color: #e3f2fd;
        }
        .file-list {
            margin: 20px 0;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        .file-item:nth-child(even) {
            background-color: #f9f9f9;
        }
        .settings {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .settings label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        .settings input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 3px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            display: none;
        }
        #status.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        #status.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .help-text {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .field-mapping {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        .field-mapping th, .field-mapping td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .field-mapping th {
            background-color: #f2f2f2;
        }
        .field-mapping tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>Объединение Excel файлов</h1>
    
    <div class="drop-area" id="dropArea">
        <p>Перетащите файлы Excel сюда или</p>
        <button id="browseButton">Выбрать файлы</button>
        <input type="file" id="fileInput" multiple accept=".xlsx,.xls" style="display: none;">
    </div>
    
    <div id="fileList" class="file-list">
        <h2>Выбранные файлы:</h2>
        <div id="files"></div>
    </div>
    
    <div class="settings">
        <h2>Настройки объединения</h2>
        
        <label for="groupByColumns">Группировать по столбцам (через запятую):</label>
        <input type="text" id="groupByColumns" value="3,17,12">
        <p class="help-text">По умолчанию: 3 (компания), 17 (Инкотермс), 12 (таможня назначения)</p>
        
        <label for="concatColumns">Конкатенировать столбцы (через запятую):</label>
        <input type="text" id="concatColumns" value="8,11,15,16,6">
        <p class="help-text">По умолчанию: 8 (страны отправления), 11 (страны назначения), 15 (коды ТНВЭД), 16 (товарные знаки), 6 (контактная информация)</p>
        
        <div>
            <h3>Соответствие полей</h3>
            <table class="field-mapping">
                <tr>
                    <th>Номер поля</th>
                    <th>Поле лида</th>
                </tr>
                <tr><td>1</td><td>отправитель</td></tr>
                <tr><td>2</td><td>адрес отправителя</td></tr>
                <tr><td>3</td><td>контрактодержатель</td></tr>
                <tr><td>4</td><td>адрес контарктодерж</td></tr>
                <tr><td>5</td><td>ИНН</td></tr>
                <tr><td>6</td><td>контактная информация</td></tr>
                <tr><td>7</td><td>торгующая страна</td></tr>
                <tr><td>8</td><td>страна отправления</td></tr>
                <tr><td>9</td><td>страна происхождения</td></tr>
                <tr><td>10</td><td>производитель</td></tr>
                <tr><td>11</td><td>страна назначения</td></tr>
                <tr><td>12</td><td>таможня назначения</td></tr>
                <tr><td>13</td><td>тип транспорта</td></tr>
                <tr><td>14</td><td>описание товара</td></tr>
                <tr><td>15</td><td>код ТНВЭД</td></tr>
                <tr><td>16</td><td>товарный знак</td></tr>
                <tr><td>17</td><td>Инкотермс</td></tr>
                <tr><td>18</td><td>пункт назначения</td></tr>
                <tr><td>19</td><td>вес брутто</td></tr>
                <tr><td>20</td><td>кол-во</td></tr>
                <tr><td>21</td><td>ед изм</td></tr>
                <tr><td>22</td><td>факт стоим</td></tr>
                <tr><td>23</td><td>валюта</td></tr>
            </table>
        </div>
    </div>
    
    <button id="mergeButton" disabled>Объединить файлы</button>
    
    <div id="status"></div>
    
    <script>
        // Маппинг номеров полей на их названия
        const fieldMappings = {
            1: 'отправитель',
            2: 'адрес отправителя',
            3: 'контрактодержатель',
            4: 'адрес контарктодерж',
            5: 'ИНН',
            6: 'контактная информация',
            7: 'торгующая страна',
            8: 'страна отправления',
            9: 'страна происхождения',
            10: 'производитель',
            11: 'страна назначения',
            12: 'таможня назначения',
            13: 'тип транспорта',
            14: 'описание товара',
            15: 'код ТНВЭД',
            16: 'товарный знак',
            17: 'Инкотермс',
            18: 'пункт назначения',
            19: 'вес брутто',
            20: 'кол-во',
            21: 'ед изм',
            22: 'факт стоим',
            23: 'валюта'
        };
        
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const browseButton = document.getElementById('browseButton');
        const fileList = document.getElementById('files');
        const mergeButton = document.getElementById('mergeButton');
        const status = document.getElementById('status');
        const groupByColumnsInput = document.getElementById('groupByColumns');
        const concatColumnsInput = document.getElementById('concatColumns');
        
        const files = [];
        
        // Обработчики для перетаскивания файлов
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        // Обработка брошенных файлов
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const newFiles = [...dt.files];
            handleFiles(newFiles);
        }
        
        // Обработка выбранных файлов через кнопку
        browseButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', () => {
            const newFiles = [...fileInput.files];
            handleFiles(newFiles);
        });
        
        function handleFiles(newFiles) {
            // Фильтруем только Excel файлы
            const excelFiles = newFiles.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );
            
            if (excelFiles.length === 0) {
                showStatus('Выбранные файлы не являются файлами Excel (.xlsx, .xls)', 'error');
                return;
            }
            
            // Добавляем новые файлы в список
            excelFiles.forEach(file => {
                if (!files.some(f => f.name === file.name && f.size === file.size)) {
                    files.push(file);
                }
            });
            
            // Обновляем UI
            updateFileList();
            mergeButton.disabled = files.length < 1;
        }
        
        function updateFileList() {
            fileList.innerHTML = files.length ? '' : '<p>Нет выбранных файлов</p>';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>${file.name} (${formatFileSize(file.size)})</span>
                    <button class="remove-btn" data-index="${index}">Удалить</button>
                `;
                fileList.appendChild(fileItem);
            });
            
            // Добавляем обработчики для кнопок удаления
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    files.splice(index, 1);
                    updateFileList();
                    mergeButton.disabled = files.length < 1;
                });
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' байт';
            else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' КБ';
            else return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
        }
        
        mergeButton.addEventListener('click', mergeFiles);
        
        async function mergeFiles() {
            // Проверяем, есть ли файлы для объединения
            if (files.length === 0) {
                showStatus('Нет файлов для объединения', 'error');
                return;
            }
            
            // Показываем сообщение о процессе
            showStatus('Обработка файлов...', 'info');
            mergeButton.disabled = true;
            
            try {
                // Получаем значения полей группировки и конкатенации
                const groupByIndices = groupByColumnsInput.value
                    .split(',')
                    .map(num => parseInt(num.trim()) - 1) // Уменьшаем на 1 для индексации с 0
                    .filter(num => !isNaN(num));
                
                const concatIndices = concatColumnsInput.value
                    .split(',')
                    .map(num => parseInt(num.trim()) - 1) // Уменьшаем на 1 для индексации с 0
                    .filter(num => !isNaN(num));
                
                // Обрабатываем все файлы
                let allData = [];
                let headersAdded = false;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    showStatus(`Обработка файла ${i + 1}/${files.length}: ${file.name}`, 'info');
                    
                    try {
                        const data = await readExcelFile(file);
                        
                        // Обрабатываем данные из каждого листа
                        for (const sheetName in data) {
                            const sheetData = data[sheetName];
                            
                            if (sheetData.length > 0) {
                                // Переставляем колонки на основе порядковых номеров в первой строке
                                const reorderedData = reorderColumns(sheetData);
                                
                                // Если это первый файл и лист, добавляем заголовки
                                if (!headersAdded) {
                                    // Создаем новые заголовки на основе номеров в первой строке
                                    const newHeaders = reorderedData[0].map((header, index) => {
                                        const orderValue = parseInt(header);
                                        
                                        if (!isNaN(orderValue) && fieldMappings[orderValue]) {
                                            return `${orderValue}. ${fieldMappings[orderValue]}`;
                                        } else if (!isNaN(orderValue)) {
                                            return `${orderValue}. Столбец ${orderValue}`;
                                        } else {
                                            return header;
                                        }
                                    });
                                    
                                    allData.push(newHeaders);
                                    headersAdded = true;
                                }
                                
                                // Добавляем данные (все строки кроме заголовка)
                                if (reorderedData.length > 1) {
                                    allData = [...allData, ...reorderedData.slice(1)];
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Ошибка при обработке файла ${file.name}:`, error);
                        showStatus(`Ошибка при обработке файла ${file.name}: ${error.message}`, 'error');
                    }
                }
                
                // Если есть данные, создаем итоговый файл
                if (allData.length > 0) {
                    // Создаем книгу и добавляем первый лист с объединенными данными
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(allData);
                    
                    // Устанавливаем ширину столбцов
                    ws['!cols'] = allData[0].map(() => ({ width: 25 }));
                    
                    XLSX.utils.book_append_sheet(wb, ws, "Merged Data");
                    
                    // Создаем сводную таблицу
                    const pivotData = createPivotTable(allData, groupByIndices, concatIndices);
                    
                    if (pivotData.length > 1) {
                        const pivotWS = XLSX.utils.aoa_to_sheet(pivotData);
                        
                        // Устанавливаем ширину столбцов для сводной таблицы
                        pivotWS['!cols'] = pivotData[0].map(() => ({ width: 20 }));
                        
                        XLSX.utils.book_append_sheet(wb, pivotWS, "Pivot Table");
                    }
                    
                    // Создаем дату для имени файла
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const fileName = `merged_data_${timestamp}.xlsx`;
                    
                    // Сохраняем (скачиваем) файл
                    XLSX.writeFile(wb, fileName);
                    
                    showStatus(`Файлы успешно объединены и сохранены как ${fileName}`, 'success');
                } else {
                    showStatus('Нет данных для объединения', 'error');
                }
            } catch (error) {
                console.error('Ошибка при объединении файлов:', error);
                showStatus(`Ошибка при объединении файлов: ${error.message}`, 'error');
            }
            
            mergeButton.disabled = false;
        }
        
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        
                        // Преобразуем все листы в массивы данных
                        const result = {};
                        wb.SheetNames.forEach(name => {
                            result[name] = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
                        });
                        
                        resolve(result);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Не удалось прочитать файл'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = type;
            status.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 30000); // Скрываем через 30 секунд
            }
        }
        
        // Function to trim country name to 2 characters
        function trimCountryName(value, columnIndex) {
            if (columnIndex === 6 || columnIndex === 7) {
                if (typeof value === 'string' && value.length > 2) {
                    return value.substring(0, 2);
                }
            }
            return value;
        }
        
        // Function to reorder columns based on first row values
        function reorderColumns(data) {
            if (!data || data.length < 2) return data;
            
            const firstRow = data[0];
            
            const columnOrder = firstRow.map((value, index) => {
                const orderValue = parseInt(value);
                return {
                    index: index,
                    order: isNaN(orderValue) ? -1 : orderValue,
                    header: value
                };
            });
            
            const validColumns = columnOrder.filter(col => col.order !== 0);
            
            if (validColumns.length === 0) return data;
            
            const numberedColumns = validColumns.filter(col => col.order > 0);
            const maxColumnOrder = numberedColumns.reduce((max, col) => Math.max(max, col.order), 0);
            
            const orderedColumnsMap = new Array(maxColumnOrder).fill(null).map(() => ({
                indices: [],
                header: ''
            }));
            
            numberedColumns.forEach(col => {
                const index = col.order - 1;
                orderedColumnsMap[index].indices.push(col.index);
                
                if (orderedColumnsMap[index].header && orderedColumnsMap[index].header !== col.header) {
                    orderedColumnsMap[index].header += ' / ' + col.header;
                } else {
                    orderedColumnsMap[index].header = col.header;
                }
            });
            
            const columnsWithoutOrder = validColumns.filter(col => col.order === -1);
            
            const newData = [];
            const newHeaders = [];
            
            orderedColumnsMap.forEach(column => {
                newHeaders.push(column.header || '');
            });
            
            columnsWithoutOrder.forEach(col => {
                newHeaders.push(firstRow[col.index] || '');
            });
            
            newData.push(newHeaders);
            
            for (let i = 3; i < data.length; i++) {
                const row = data[i];
                const newRow = [];
                
                orderedColumnsMap.forEach((column, colIndex) => {
                    if (column.indices.length === 0) {
                        newRow.push('');
                    } else if (column.indices.length === 1) {
                        let value = row[column.indices[0]] || '';
                        value = trimCountryName(value, colIndex);
                        newRow.push(value);
                    } else {
                        const values = column.indices
                            .map(idx => {
                                let value = row[idx] || '';
                                value = trimCountryName(value, colIndex);
                                return value;
                            })
                            .filter(val => val !== '');
                        
                        newRow.push(values.join(' / '));
                    }
                });
                
                columnsWithoutOrder.forEach(col => {
                    newRow.push(row[col.index] || '');
                });
                
                newData.push(newRow);
            }
            
            return newData;
        }
        
        // Функция для создания сводной таблицы
        function createPivotTable(data, groupByIndices, concatIndices) {
            if (!data || data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            const groupedData = {};
            
            rows.forEach(row => {
                const groupKey = groupByIndices.map(idx => row[idx] || '').join('|');
                
                if (!groupedData[groupKey]) {
                    groupedData[groupKey] = {
                        count: 0,
                        rows: [],
                        concatValues: groupByIndices.map(idx => ({
                            colIndex: idx,
                            value: row[idx] || ''
                        }))
                    };
                }
                
                groupedData[groupKey].count++;
                groupedData[groupKey].rows.push(row);
            });
            
            const allColumnIndices = Array.from({ length: headers.length }, (_, i) => i);
            
            const regularIndices = allColumnIndices.filter(idx => 
                !groupByIndices.includes(idx) && !concatIndices.includes(idx)
            );
            
            const columnOrder = [
                ...groupByIndices, 
                -1,
                ...concatIndices,
                ...regularIndices
            ];
            
            const pivotHeaders = columnOrder.map(idx => {
                if (idx === -1) {
                    return 'кол-во записей';
                } else if (idx === 2) { // 3-й столбец (индекс 2)
                    return 'компания';
                } else if (idx === 16) { // 17-й столбец (индекс 16)
                    return 'Инкотермс';
                } else if (idx === 11) { // 12-й столбец (индекс 11)
                    return 'таможня назначения';
                } else if (idx === 7) { // 8-й столбец (индекс 7)
                    return 'страны отправления';
                } else if (idx === 10) { // 11-й столбец (индекс 10)
                    return 'страны назначения';
                } else if (idx === 14) { // 15-й столбец (индекс 14)
                    return 'коды ТНВЭД';
                } else if (idx === 15) { // 16-й столбец (индекс 15)
                    return 'товарные знаки';
                } else if (idx === 5) { // 6-й столбец (индекс 5)
                    return 'контактная информация';
                } else if (groupByIndices.includes(idx)) {
                    return `[ГРУППА] ${headers[idx]}`;
                } else if (concatIndices.includes(idx)) {
                    return `[КОНКАТ] ${headers[idx]}`;
                } else {
                    return `[ПЕРВЫЙ] ${headers[idx]}`;
                }
            });
            
            const pivotData = [pivotHeaders];
            
            Object.keys(groupedData).forEach(groupKey => {
                const group = groupedData[groupKey];
                const pivotRow = [];
                
                columnOrder.forEach(idx => {
                    if (idx === -1) {
                        pivotRow.push(group.count.toString());
                        return;
                    }
                    
                    if (groupByIndices.includes(idx)) {
                        const groupIndex = groupByIndices.indexOf(idx);
                        pivotRow.push(group.concatValues[groupIndex].value);
                        return;
                    }
                    
                    if (concatIndices.includes(idx)) {
                        const uniqueValues = new Set();
                        group.rows.forEach(row => {
                            if (row[idx] && row[idx] !== '') {
                                uniqueValues.add(row[idx]);
                            }
                        });
                        pivotRow.push(Array.from(uniqueValues).join(', '));
                        return;
                    }
                    
                    let value = '';
                    for (const row of group.rows) {
                        if (row[idx] && row[idx] !== '') {
                            value = row[idx];
                            break;
                        }
                    }
                    pivotRow.push(value);
                });
                
                pivotData.push(pivotRow);
            });
            
            return pivotData;
        }
    </script>
</body>
</html>